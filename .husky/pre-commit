#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Pre-commit checks..."

# Run tests before commit
echo "Running tests..."
npm test || {
  echo "‚ùå Tests failed. Commit aborted."
  exit 1
}

# Check for uncommitted changes in package.json
if git diff --cached --name-only | grep -q "package.json"; then
  echo "‚ö†Ô∏è  package.json changed - ensure version is updated if needed"
fi

# Check for console.log in staged source files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(mjs|js)$" || true)
if [ -n "$STAGED_FILES" ]; then
  if echo "$STAGED_FILES" | xargs grep -l "console\.log" 2>/dev/null; then
    echo "‚ö†Ô∏è  Warning: console.log found in staged files"
  fi
fi

# Hookwise - Documentation bloat detection (optional, can be disabled)
# Note: hookwise is a local package helper - check if available
if [ -f "../hookwise/src/hooks/doc-bloat.mjs" ]; then
  # Use hookwise from sibling directory
  node ../hookwise/src/hooks/doc-bloat.mjs || exit 1
elif [ -f "node_modules/@arclabs561/hookwise/src/hooks/doc-bloat.mjs" ]; then
  # Try npm package if installed
  node node_modules/@arclabs561/hookwise/src/hooks/doc-bloat.mjs || exit 1
fi

echo "‚úÖ Pre-commit checks passed"
