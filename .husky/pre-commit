#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Pre-commit checks..."

# Secret detection
echo "Checking for secrets..."
if [ -f "scripts/detect-secrets.mjs" ]; then
  node scripts/detect-secrets.mjs || {
    echo "‚ùå Secret detection failed. Commit aborted."
    exit 1
  }
else
  echo "‚ö†Ô∏è  Warning: detect-secrets.mjs not found, skipping secret check"
fi

# Documentation bloat check
echo "Checking for documentation bloat..."
if [ -f "scripts/check-docs-bloat.mjs" ]; then
  node scripts/check-docs-bloat.mjs || {
    echo "‚ùå Documentation bloat check failed. Commit aborted."
    exit 1
  }
else
  echo "‚ö†Ô∏è  Warning: check-docs-bloat.mjs not found, skipping docs check"
fi

# Run tests before commit
echo "Running tests..."
npm test || {
  echo "‚ùå Tests failed. Commit aborted."
  exit 1
}

# Check for uncommitted changes in package.json
if git diff --cached --name-only | grep -q "package.json"; then
  echo "‚ö†Ô∏è  package.json changed - ensure version is updated if needed"
fi

# Check for console.log in staged source files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(mjs|js)$" || true)
if [ -n "$STAGED_FILES" ]; then
  if echo "$STAGED_FILES" | xargs grep -l "console\.log" 2>/dev/null; then
    echo "‚ö†Ô∏è  Warning: console.log found in staged files"
  fi
fi

echo "‚úÖ Pre-commit checks passed"
